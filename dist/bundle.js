/*!
*  View plugin
* 
*  @version 3.0.0
*  @package https://github.com/sosie-js/view-plugin
*/
class EditorBroadcastChannel{constructor(e,t){const o=new window.BroadcastChannel(e);var a=this;o.onmessage=e=>{this.disabled?(console.info("Message received in view-plugin but ignored:",e.data),a.enable(": storm is over")):(console.info("Broadcast received in view-plugin and processed:",e.data),t(e.data.index,e.data.action,e.data.data))},o.onmessageerror=e=>{console.error("Broadcast received an error:",e)},this.currentIndex=0,this.bc=o}disable(e){console.log("EditorBroadcastChannel disabled "+e),this.disabled=!0}enable(e){console.log("EditorBroadcastChannel enabled "+e),this.disabled=!1}postMessage(e){if(!this.disabled){try{"insert"!=e.action&&"remove"!=e.action||this.disable(": send and protect against "+e.action),this.bc.postMessage(e)}catch(t){console.error(t,e)}}}close(){this.bc.close()}}class ViewPlugin{constructor(){}initBroadcast(e){e.broadcast=new EditorBroadcastChannel("block_channel",(function(t,o,a){var n;switch(o){case"sync":e.blocks.scrollToBlock(t,a.y),setCurrentPosition(t+1),refreshTotalBlocks();break;case"insert":n=e.blocks.getBlockByIndex(t-1),console.info("insert block at index "+t+"with id "+a.id),n.save().then(a=>{console.log("Insert with block data",a),console.log("Insert with block config",n.config),e.broadcast.disable(": prevention against "+o),e.blocks.insert(a.tool,n.config,a.data,t,!0),e.broadcast.enable(": remove prevention of "+o)});break;case"remove":e.broadcast.disable(": prevention against "+o),e.blocks.delete(e.broadcast.currentIndex+1),e.broadcast.enable(": remove prevention of "+o);break;case"edit":e.broadcast.currentIndex=t}}))}init(e){function t(){return"${currentScript}".replace("/dist/bundle.js","")}let o=t();console.log("File plugin found in "+o);var a,n="local:"+o;window.hasOwnProperty("loadEditor")?(async()=>{await loadEditor([{"jsondiffpatch@0.4.1":["[src/jsondiffpatch.umd.js](https://github.com/benjamine/jsondiffpatch)","../../dist/jsondiffpatch.umd.js"]},{"jsdiff.js@latest":["[src/jsdiff.js](https://johnresig.com/files/jsdiff.js)","../../dist/jsdiff.js"]}],!1,"prod",n)})():alert("You need to load sosie-js/script-loader version 3.0.+ available on github"),window.openChildWindow=function(e,t){a&&closeChildWindow();(a=window.open(e,"_blank","location=no,height=570,width=800,scrollbars=yes,status=yes")).document.write(t),a.focus()},window.closeChildWindow=function(){a?(a.close(),a=void 0):alert("There is no child window open.")},window.refreshChildWindow=function(){a?a.location.reload():alert("There is no child window open.")},window.webservice_HTMLrenderFromJSON=function(e,t){window.webservice_HTMLrender(function(e){var t="",o=new Array;return e.blocks.forEach((function(e){try{switch(e.type){case"header":t+=`<h${e.data.level}>${e.data.text}</h${e.data.level}>\n`;break;case"paragraph":t+=`<p>${e.data.text}</p>\n`;break;case"delimiter":t+='<p align="center">* * *</p>';break;case"image":Object.prototype.hasOwnProperty.call(e.data,"file")?t+=`<img class="img-fluid" src="${e.data.file.url}" title="${e.data.caption}" /><br /><em>${e.data.caption}</em>`:t+=`<img class="img-fluid" src="${e.data.url}" title="${e.data.caption}" /><br /><em>${e.data.caption}</em>`;break;case"list":t+="<ul>\n",e.data.items.forEach((function(e){t+=`\t<li>${e}</li>\n`})),t+="</ul>\n";break;case"raw":t+=""+e.data.html,e.data.text&&o.push(""+e.data.text);break;default:console.log("Unknown block type",e.type),console.log(e)}}catch(t){console.log("Error for block type "+e.type,t)}})),t}(e),t)},window.webservice_HTMLrender=function(e,o){o&&(e=function(e){let o="",a=t();return"jsdiff.js"==e&&(o="<style>\n\tins { background-color: #cdffd8; }\n\tdel { background-color: #ffdce0; }\n</style>"),"jsondiffpatch"==e&&(o='<link rel="stylesheet" href="'+a+'/dist/formatters-styles/html.css" type="text/css" media="screen" />',o+='<link rel="stylesheet" href="'+a+'/dist/formatters-styles/annotated.css" type="text/css" media="screen" />'),o}(o)+e),openChildWindow("",e)},this.initBroadcast(e),console.log("View plugin initialized ")}}var View=new ViewPlugin;SoSIE.register("View");